---
title: SmartMatch 匹配
author: KevinAsgari
description: 了解有关在多人游戏中匹配玩家的 Xbox Live SmartMatch 匹配服务的信息。
ms.assetid: ba0c1ecb-e928-4e86-9162-8cb456b697ff
ms.author: kevinasg
ms.date: 04/04/2017
ms.topic: article
ms.prod: windows
ms.technology: uwp
keywords: xbox live, xbox, 游戏, uwp, windows 10, xbox one, 多人游戏, 匹配, smartmatch
ms.localizationpriority: low
ms.openlocfilehash: 5214b85ca7a0e4f8460044b34279895027d0b8d4
ms.sourcegitcommit: 01760b73fa8cdb423a9aa1f63e72e70647d8f6ab
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/24/2018
---
# <a name="smartmatch-matchmaking"></a>SmartMatch 匹配

本文包含以下几个部分
* SmartMatch 简介
* SmartMatch 运行时操作
* 为你的游戏配置 SmartMatch
* 在 SmartMatch 配置期间定义团队规则
* 目标会话初始化和 QoS

## <a name="introduction-to-smartmatch"></a>SmartMatch 简介

XSAPI 提供了一种叫做 SmartMatch 的匹配服务，它由[多人游戏管理器 API](../multiplayer-manager/multiplayer-manager-api-overview.md) 包装。  有关高级 API 使用情况的信息，可参考 **MatchmakingService 类**，但如果你发现有使用多人游戏管理器无法实现的匹配场景，请通过 DAM 向我们提供反馈。  无论你使用何种 API，本文中的概念信息均适用。

SmartMatch 匹配基于用户信息以及想要一起游戏的用户的匹配请求来对玩家进行分组。 匹配基于服务器，这意味着用户可以提供对该服务的请求，然后他们稍后会在找到匹配时收到通知。 在为 Xbox one 创建游戏时，你可以如[使用 SmartMatch 匹配](using-smartmatch-matchmaking.md)中所述使用 SmartMatch。 或者，你可以如[使用你自己的匹配服务](https://developer.microsoft.com/en-us/games/xbox/docs/xboxlive/xbox-live-partners/multiplayer-and-networking/using-your-own-matchmaking-service)中所述使用你自己的匹配服务。 请注意，访问该链接要求你拥有为 Xbox Live 开发启用的 Microsoft 开发人员中心帐户。

### <a name="about-smartmatch"></a>关于 SmartMatch

该匹配服务与 MPSD 紧密协作，可简化匹配。 它允许游戏在后台轻松匹配，例如，当用户在游戏内玩单人游戏时。

想要进入匹配的个人或小组创建匹配票证会话，然后请求匹配服务查找其他要开始与其建立匹配的玩家。 这将导致在一段时间内创建驻留在匹配服务内的临时“匹配票证”。

匹配服务会基于配置、为各玩家存储的统计信息以及在匹配请求时给定的任何其他信息选择会话以共同游戏。 然后，该服务创建匹配目标会话，此会话包含已匹配的所有玩家，并向用户的游戏告知匹配。

目标会话准备就绪后，游戏执行 QoS 检查以确认该组可以一起游戏，然后如果所有玩家已就绪，即可开始游戏。 在 QoS 过程和匹配游戏期间，游戏在 MPSD 内使会话状态保持最新并从 MPSD 接收关于会话更改的通知。 此类更改包括用户的进出，以及对会话仲裁程序的更改。


### <a name="match-ticket-session"></a>匹配票证会话

匹配票证会话表示适用于想要进行匹配的玩家的客户端。 它基于游戏，或同时位于大厅的一组陌生人，或基于其他特定于游戏的玩家分组创建。 在某些情况下，票证会话可能是已在进行中并在寻找更多玩家的游戏会话。


### <a name="match-ticket"></a>匹配票证

向匹配提交票证会话会创建跟踪匹配尝试的匹配票证。 票证中的属性（例如游戏地图或者玩家级别）以及票证会话中的玩家的属性用于确定匹配。
#### <a name="hoppers"></a>漏斗

漏斗是收集匹配票证的逻辑位置。 仅可匹配同一漏斗内的票证。 一个游戏可以有多个漏斗。 例如，游戏可以创建一个漏斗，对于该漏斗来说，玩家技能是最重要的匹配项目。 它可以使用另一个漏斗，在该漏斗中，只有玩家购买了相同的可下载内容才会匹配。


#### <a name="hopper-rules"></a>漏斗规则

漏斗规则提供匹配服务用于确定要将哪些玩家分组在一起的条件的定义。 有两种类型的规则：MUST 规则 -- 必须满足这些规则，匹配票证才会被视为兼容。
-   SHOULD 规则 -- 匹配规则的匹配票证要优于不匹配规则的票证。

在每个类别中，有以下几种特定类型的规则。 有关更多信息，请参阅 **SmartMatch 运行时操作**中的运行时操作配置信息。


### <a name="match-target-session"></a>匹配目标会话

找到匹配的组后，该服务将创建匹配目标会话，并为匹配在一起的票证会话中的所有玩家保留位置。


## <a name="smartmatch-runtime-operations"></a>SmartMatch 运行时操作



| 注意                                                                                                                                  |
|----------------------------------------------------------------------------------------------------------------------------------------------------|
| 有关在你的游戏中使用 SmartMatch 匹配的信息，请参阅[使用 SmartMatch 匹配](using-smartmatch-matchmaking.md)。 |


### <a name="creating-a-match-ticket-session-and-a-match-ticket"></a>创建匹配票证会话和匹配票证

指定为匹配“侦察兵”的客户端会对匹配票证会话进行设置，以代表想要进入匹配的一组玩家。 该组中的所有玩家都加入使用 MultiplayerSession.Join 方法的会话。 使用玩家填充会话后，游戏使用 MatchmakingService.CreateMatchTicketAsync 方法将会话提交到匹配服务，从而创建代表会话的匹配票证。

| 注意                                                                                                                                                        |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SmartMatch 服务在 CreateMatchTicketAsync 操作期间将票证会话中的 /servers/matchmaking/properties/system/status 字段更新为“搜索”。 |

匹配票证创建方法的响应是 CreateMatchTicketResponse 对象。 响应包含匹配票证 ID，一个可用于通过删除票证取消匹配的 GUID。 此外，漏斗的平均等待时间包含在设置玩家期望时使用的响应中。

| 注意                                                                                                                                                                                                                                                                                                                                 |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 除非有需要保留的特定游戏统计数据，否则，建议游戏在调用 CreateMatchTicketAsync 时使用 PreserveSessionMode.Never 值。 相对于搜索游戏，使用 PreserveSessionMode.Never 能够更快速地进行匹配，并且无需具备用于托管游戏的用户界面选项。 |


### <a name="setting-matchmaking-attributes-on-the-session-and-players"></a>设置会话和玩家的匹配属性

提交票证会话时，游戏设置匹配服务用于将会话与其他会话分组在一起的会话和玩家属性。 可在票证级别或每个成员级别指定属性。


### <a name="setting-matchmaking-attributes-at-the-match-ticket-level"></a>在匹配票证级别设置匹配属性

游戏在 MatchmakingService.CreateMatchTicketAsync 方法的 ticketAttributesJson 参数中的匹配票证级别提交属性。 在票证级别上指定的属性替代了在每个成员级别上指定的相同属性。


#### <a name="setting-matchmaking-attributes-at-the-per-member-level"></a>在每个成员级别设置匹配属性

游戏指定匹配票证会话内的各成员的每个成员属性。 通过使用“matchAttrs”的属性名称并调用 MultiplayerSession.SetCurrentUserMemberCustomPropertyJson 方法来对它们进行设置。 此调用将 /members/{index}/properties/custom/matchAttrs 字段中的属性置于票证会话中的每个玩家上。

基于为漏斗的 XDP 配置 UI 中的属性指定的平展方法，匹配过程将每个成员“平展”为单个票证级别属性。


### <a name="making-the-match"></a>进行匹配

通过设置的票证会话和匹配票证，匹配服务将表示的票证会话与表示其他组的其他票证会话匹配，并创建或标识匹配目标会话。 此服务也会为目标会话中的匹配玩家创建预留，然后将票证会话标记为已匹配。 然后，MPSD 通知游戏此次对票证会话的更改。

现在，游戏必须初始化目标会话以确认是否已显示足够的玩家，并执行服务质量 (QoS) 检查以确保他们彼此可以成功连接。 如果初始化和/或 QoS 失败，游戏会标记要重新提交给匹配的票证会话，以便可以查找其他组。 有关此过程的更多信息，请参阅**目标会话初始化和 QoS**。

在匹配活动期间，会话中的 JSON 对象进行了如下更改：

-   /servers/matchmaking/properties/system/status 字段设置为“已找到”。
-   /servers/matchmaking/properties/system/targetSessionRef 字段设置为目标会话。
-   将各票证会话的 /members/{index}/properties/custom/matchAttrs 字段复制到 members/{index}/constants/custom/matchmakingResult/playerAttrs 字段。
-   对于每个玩家，将票证属性从匹配票证中的 ticketAttributes 字段复制到 /members/{index}/constants/custom/matchmakingResult/ticketAttrs 字段。


### <a name="maintaining-the-match-ticket"></a>保留匹配票证

匹配服务使用为会话创建匹配票证时的票证会话快照。 因此，如果任何玩家加入或离开票证会话，则游戏必须使用匹配服务，删除并重新创建匹配票证。


### <a name="filling-spots-in-an-in-progress-game-session"></a>填补正在进行的游戏会话中的位置

游戏可以将现有游戏会话重新作为匹配票证会话使用，以便寻找更多玩家加入正在进行的游戏，或者在一轮游戏结束，某些玩家离开后填充游戏会话。 此过程称为“回填”。

一种执行回填的方法是通过调用 **MatchmakingService.CreateMatchTicketAsync 方法**（其中 preserveSession 参数设置为 PreserveSessionMode.Always）创建将“保留”正在进行的会话的匹配票证。 然后，匹配服务可确保现有会话在整个匹配过程中都会得到保留并成为生成的目标会话。

此模式可能存在一些缺点，将 preserveSession 设置为“始终”的两个会话将无法互相匹配，因为无法将它们合并。 这可能导致回填匹配非常缓慢。 为了避免这种情况，如果需要保留游戏状态，游戏应仅使用 PreserveSessionMode.Always。 Otherwis 设置 PreserveSessionMode.Never，并在找到匹配时将玩家迁移到新 targetSession。


### <a name="deleting-the-match-ticket"></a>删除匹配票证

若要删除匹配票证，游戏将调用 **MatchmakingService.DeleteMatchTicketAsync 方法**。 在删除票证时，匹配服务将：

1.  停止匹配票证会话中的用户。
2.  将票证会话中的 /servers/matchmaking/properties/system/status 字段更新为“已取消”。


### <a name="matchmaking-for-games-using-xbox-live-compute"></a>使用 Xbox Live 计算进行游戏匹配

下面的示例演示了使用 Live 计算服务进行高级匹配。 类似的方法可以应用于第三方资源上托管的游戏。

1.  “侦察兵”客户端创建票证会话以表示组。 此会话包含潜在的数据中心列表（位于 /constants/system/measurementServerAddresses 中的会话配置）。 如果数据中心列表为静态，则此会话来自会话模板，或者来自从 Live 计算服务接收会话后，在创建会话时的客户端。 此会话还包含 targetSessionConstants/custom/gameServerPlatform 对象中的 gsiSetId、gameVariantId 和 maxAllowedPlayers 值。
2.  组中的所有其他客户端加入票证会话。
3.  组的所有成员都将从票证会话的 /constants/system 对象下载 measurementServerAddresses 值。 然后每个成员使用平台 API 对每个地址执行 ping 操作，并将有序的首选数据中心列表上传到会话中，如 /members/{index}/properties/system/serverMeasurements 中所定义。

| 注意                                                                                                                                                                                                                                                                                                                                                                       |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 游戏可以使用 **MultiplayerSession.SetMeasurementServerAddresses 方法**和**MultiplayerSessionConstants.MeasurementServerAddressesJson 属性**设置并检索会话中的 measurementServerAddresses 值。 |

4.  “侦察兵”客户端将调用 **MatchmakingService.CreateMatchTicketAsync 方法**，传入对票证会话的引用。

| 注意                                                                                                                                                                                                  |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 如果票证会话对象有不匹配的常量，则 CreateMatchTicket 方法可能会失败。 这可以通过将 MUST 规则添加到漏斗和阻止与具有不匹配常量的玩家匹配来避免。 |

5.  如果 **MatchTicketDetailsResponse.PreserveSession 属性**设置为“从不”，匹配服务会将每个成员的服务器度量复制到票证的内部表示形式中，然后再将收集的内容平展到单个票证集合并存储为“特殊”票证属性。
6.  如果将 **MatchTicketDetailsResponse.PreserveSession 属性**设置为“始终”，则不使用服务器度量。 相反，匹配服务将会话的 /properties/system/matchmaking/serverConnectionString 值复制到票证的内部表示（作为大小为 1 且零延迟的 serverMeasurements 集合）。
7.  匹配服务将票证会话与代表其他组的票证会话进行匹配（将服务器度量集合考虑在内）。 它将尝试匹配组与具有高度首选的相同数据中心的其他组。
8.  一旦发现匹配的组，匹配服务创建或标识目标会话并添加一起匹配的票证会话的所有玩家。 该服务为匹配的组将最终平展的服务器度量写入到 /properties/system/serverConnectionStringCandidates。 然后，它为目标会话中各个新成员将原始的服务器度量写入 /members/{index}/constants/system/matchmakingResult/serverMeasurements。
9.  如上所述，所有客户端对目标会话执行初始化。 但是，因为客户端将连接到 Live 计算，因此它们无法相互执行 QoS 以确认连接。
10. 部分或全部客户端调用 **GameServerPlatformService.AllocateClusterAsync 方法**。 第一个会触发分配，而其他的只会收到确认。 此方法从 MPSD 中获取目标会话，并基于目标会话中的数据中心首选项选择数据中心、负载和其他 Live 计算特定的知识。
11. 所有客户端都运行。

## <a name="configuring-smartmatch-for-your-title"></a>为你的游戏配置 SmartMatch


### <a name="configuration-of-smartmatch-matchmaking-runtime-operations"></a>SmartMatch 匹配运行时操作配置

SmartMatch 匹配的所有配置通过[Xbox 开发人员门户 (XDP)](https://xdp.xboxlive.com) 完成。 配置使用游戏的“ServiceConfiguration-&gt;多人游戏和匹配”部分。


#### <a name="matchmaking-session-template-configuration"></a>匹配会话模板配置

如 [SmartMatch 匹配]()中所述，有两种类型的会话与匹配相关：匹配票证会话和匹配目标会话。 基本上，票证会话是匹配服务的输入，而目标会话是输出。 在 XDP 中配置会话模板时，你应该为每个会话类型创建一个模板。

对于票证会话，你可以使用专用模板。 或者，你可以将模板重新用于大厅会话或其他不用于游戏的会话。

| 重要提示                                                                                      |
|-------------------------------------------------------------------------------------------------------------|
| 票证会话不能启用 QoS 检查，并且不得标有“游戏”功能。 |

对于目标会话，你必须创建用于配对游戏的模板。 它应具备可在开始游戏之前在玩家间启用 QoS 检查的设置，并且必须标有“游戏”功能。

在 XDP UI 中，你可以将每个会话映射到一个或多个漏斗，每个漏斗中包含确定如何将会话匹配在一起的规则。 有关更多信息，请参阅“用于匹配的基本漏斗配置”。


#### <a name="basic-hopper-configuration-for-matchmaking"></a>用于匹配的基本漏斗配置

本部分中定义了用于配置基本漏斗字段的字段。 完成此配置后，你必须配置漏斗规则，如“漏斗规则配置”中所述。

![](../../images/multiplayer/session_template_hopper_edit.png)


###### <a name="name"></a>名称

将会话提交给匹配时所使用的漏斗的名称。 该名称必须与在创建匹配票证期间作为参数传递给 **CreateMatchTicketAsync** 方法的值匹配。


###### <a name="minmax-group-size"></a>最小/最大组大小

从漏斗中的会话创建的玩家组的最小和最大大小。 匹配服务尝试创建尽可能大的匹配组，达到最大组大小。 但是，如果可以将足够数量的玩家汇集到一起以满足最小组大小，即创建了匹配组。


###### <a name="should-rule-expansion-cycles"></a>Should 规则扩展周期

对于 SHOULD 规则，匹配服务将尝试扩大搜索位置，如果未成功找到匹配，会逐渐放宽提供的匹配规则。 此过程在多个周期中执行，如使用“Should 规则扩展周期“字段所指定。 到最后一个扩展周期时，SHOULD 规则会被删除，以便它们不会再阻止票证进行匹配。 但是，它们仍然可用于确定最佳匹配项（如果有多个票证可用）。 在删除它们之前，仅扩展数字和 QoS 类型。 另请参阅本主题中的“漏斗规则配置”。

增大“Should 规则扩展周期”设置的值会为 SHOULD 规则扩展提供更多周期，而且还会延长匹配持续时间。 默认值为 3，通常这对于大多数配置已足够。

| 重要提示                                                                                                                                                                        |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 扩展周期的固定时间间隔为 5 秒。 到最后一个扩展周期时，其余匹配尝试都将不再考虑所有的“Should”规则。 |

##### <a name="ranked-hopper"></a>排名漏斗
一般情况下，SmartMatch 将禁止匹配已被阻止的玩家。 如果选中“排名漏斗”，会绕过该逻辑，以防止玩家使用该系统避开技能更高的玩家。

#### <a name="configuration-of-hopper-rules"></a>漏斗规则配置

本部分定义了用于配置漏斗规则的字段。

###### <a name="common-rule-fields"></a>常见规则字段

在本部分中定义的字段适用于所有漏斗规则。

**规则名称**

出于配置目的，为规则显示了友好名称。

**规则类型**

规则类型。 选项包括 MUST 和 SHOULD。 要成功进行匹配，必须满足 MUST 规则。 为了成功匹配，可放宽和/或删除 SHOULD 规则。 有关此过程的更多详细信息，请参阅“SHOULD 规则扩展配置”。


**数据类型**

匹配规则属性的数据类型。 可能的值为：数字。 指定简单的 32 位数值。
-   字符串。 指定最多 128 个字符的 Unicode 字符串。
-   集合。 指定一组字符串。 使用此值确定可下载内容 (DLC)、会员阵容或玩家的角色偏好。
-   服务质量。 指定用于在匹配中包含延迟 QoS 数据的自定义数据类型。 每个匹配漏斗只能使用一个此类规则。

| 注意 |
|----------|
| 如果此限制给你的游戏带来了麻烦，请联系你的开发人员帐户管理员。 |

-   总值。 指定总计提交的匹配值的自定义数据类型。 你可以使用此值确保生成的总和在特定范围内，或者是确切值。
-   团队。 为匹配请求中包含的玩家团队指定自定义数据类型。 你可以使用此值避免在多个团队之间拆分单个匹配票证内的玩家。


###### <a name="data-type-specific-rule-fields"></a>数据类型特定规则字段

本部分定义了用于定义适用于某些数据类型但不适用于其他数据类型的规则的字段。 XDP UI 应该能够阐明哪些数据类型适用于特定规则。

**允许使用通配符**

指示是否可以在匹配票证中忽略属性的值。 如果忽略，票证将与任何其他票证兼容，而不考虑此属性的值。


**属性源**

数据类型值的源。 可能的源为：
- 提供的游戏。 在匹配票证中提交数据值。
-   用户统计信息实例。 从 UserStatistics 服务自动检索数据值。


**属性名称**

属性值源的名称。 它是匹配票证中的属性名称，或用户统计信息的名称。


**默认值**

未指定或没有可用于匹配请求的值时数据类型的默认值。 如果选中“允许使用通配符”字段且未指定任何值，则默认值不适用。


**权重**

规则的重要性。 权重可用于指示匹配和规则扩展期间哪些规则优先使用。 权重值必须为正数，默认值为 1。


**平展方法**

仅支持“数字”数据类型。 指示如何合并多个值以满足匹配的值。 它适用于单个匹配票证中以及跨多个票证的不同玩家的多个值。 可能的值为：
-  最小值/最大值。 使用来自不同匹配票证的多个值的最小值或最大值。
-   平均值。 使用来自不同匹配票证的多个值的平均值。


**最大差值**

仅支持“数字”数据类型。 为满足规则两个比较值之间可接受的最大数值差。 对于 SHOULD 规则，此值为规则扩展的起点。


**设置操作**

仅支持“集合”数据类型。 匹配设置值组时要执行的操作。 可能的选项为：
- 交集。 基于两个集合之间的交集量对它们进行匹配。 此设置会产生类似或相同的集合值。
-   差异。 基于两个集合之间的差异程度对它们进行匹配。
-   角色偏好。 根据基于角色的游戏模式中玩家的角色偏好对集合进行匹配。


**目标交集**

设置操作配置的一部分。 匹配之前，两个集合的最小交集或最大差异。


**网络拓扑**

仅支持“服务质量”数据类型。 用于 QoS 的网络拓扑。 可能的值为“对等”、“端点对主机”以及“客户端/服务器”。


**最大延迟/最大缩放**  
仅支持“服务质量”数据类型。 指定的网络拓扑内成功匹配的最大延迟。 使用客户端服务器服务质量的 should 规则时，此值会被视为缩放值（相对于必要的延迟）。


| 注意                                                                                                                                                           |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 此外，默认信誉规则也适用于漏斗。 这些规则无法删除，且不能用于确保在匹配期间正确处理信誉。 |


**允许等待角色**

仅支持“集合角色偏好”数据类型。 指定是否此匹配服务持有匹配票证以填充所有可用的角色。


###### <a name="expansion-delta"></a>扩展增量

表示针对每个扩展生成提交规则的放宽程度的值。 除了最大差值，还应用了扩展增量。 有关详细信息，请参阅示例 1（规则扩展）。

你还可以使用扩展增量以不同速度扩展多个数值。 这在扩展周期配置设置中是不可能的，因为它适用于所有规则。 相反，方法是使用小数点扩展值，例如，0.4。 仅在达到新整数时才会发生扩展，从而允许有不同的扩展速度，即使对于相同数量的扩展周期亦是如此。


###### <a name="qos-expansion-peer-to-peer-peer-to-host"></a>QoS 扩展（对等、端点对主机）
对于对等游戏的服务质量类型扩展，无法配置扩展增量。 相反，你应使用以下扩展策略之一。

<table>

<tr>

<tr>
<td>
<b>1. MaxLatency < 256。</b><p/><p/>

在 MaxLatency * 扩展周期执行扩展。<p/>
例如，如果初始值为 200，则在第一个周期中使用 200，在第二个周期中使用 400，以此类推。
</td>
</tr>

<tr>
<td>
<b>2. MaxLatency > 或 = 256</b><p/><p/>

扩展以线性方式从 50 扩大到 MaxLatency - 256。<p/>
例如，如果初始值为 556，值基于周期数以线性方式从 50 扩大到 300。 也就是说，如果我们选择了六个周期，那么值将为 50、100、150、200、250 和 300。 如果选择了五个周期，则值将为 50、112.5、175、237.5 和 300。
</td>
</tr>

</tr>
</table>

##### <a name="qos-expansion-client-server"></a>QoS 扩展（客户端-服务器）
使用专用服务器时，扩展基于相对优先设定。 在早期的扩展周期中，仅考虑首选服务器。 然后才会逐渐使用非首选的服务器。 为确保正确的扩展，我们需要类似于 MaxLatency 的值，称为“最大缩放值”。 此“最大缩放值”仍应设置为可接受的最长 ping 时间，但是，与为 ping 次数提供绝对要求不同，此值将为玩家提供的不同服务器 ping 次数提供相对缩放。 注意，你可以特意将具有无法接受的 ping 次数的服务器从列表中删除，以此排除这些服务器。

#### <a name="example-1-rule-expansion"></a>示例 1（规则扩展）

使用玩家级别进行匹配，将基于玩家级别的接近程度对玩家进行松散匹配。 级别差值最小的玩家将视为首选玩家。

-   玩家级别规则
-   规则类型：SHOULD
-   数据类型：数字
-   最大差值：1
-   扩展增量：2
-   平展方法：平均

默认情况下，玩家级别之间所需的差值为 1 或者更小。 如果在此差值内发现匹配，表示玩家相互匹配。 如果未发现初始匹配项，会针对每个迭代将玩家级别扩大 2（默认情况下是三个迭代）。 此方案会导致 20 级玩家的匹配行为，如下表中所示。

| 步骤                    | 潜在匹配候选项的级别值 | 成功匹配的有效级别距离 |
|-----|
| 初始提交值 | 19-21                                      | 1                                             |
| 扩展周期 1       | 17-23                                      | 3                                             |
| 扩展周期 2       | 15-25                                      | 5                                             |
| 扩展周期 3       | 13-27                                      | 7                                             |

随着扩展周期继续，成功匹配的有效级别距离会增加，而不会改变最大差值。 仅会放宽玩家级别值。


#### <a name="example-2-collection-rule"></a>示例 2（集合规则）

游戏发布了三种适用于玩家的 DLC 类型。 该匹配规则适用于“仅 DLC”游戏匹配，一个玩家应拥有至少一个 DLC 才能与其他玩家配对。

-   玩家 DLC 规则
-   规则类型：MUST
-   数据类型：集合
-   设置操作：交集
-   目标交集：1

玩家会评估其 DLC，并在其匹配票证中提交下表中所示的值。

| 注意                                                                                                                                   |
|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| 在下表中，集合值表示 DLC 的所有权。 如果 DLC 可用于玩家，则设置为 1，如果不可用于玩家，则设置为 0。 |

| 玩家   | 集合值 | 与玩家匹配 | 注意           |
|----------|------------------|----------------------|----------------|
| 玩家 1 | { "1", "1", "1"} | 3                    | 拥有所有 DLC  |
| 玩家 2 | { "0", "0", "0"} | 无                 | 没有 DLC    |
| 玩家 3 | { "1", "0", "0"} | 1                    | 拥有第一个 DLC |

如果示例中的目标交集设置为 2，则玩家 1 和 3 不匹配，因为它们之间的交集只有 1。

#### <a name="example-3-avoid-previous-players"></a>示例 3（避免以前的玩家）
游戏倾向于避免最近有玩家玩过的游戏。
* 规则类型：MUST
* 数据类型：集合
* 设置操作：差异
* 目标交集：0

## <a name="defining-team-rules-during-smartmatch-configuration"></a>在 SmartMatch 配置期间定义团队规则

### <a name="configuring-team-rules"></a>配置团队规则

若要设置团队规则，请在 XDP 中创建一个。 填写你的游戏预期从此漏斗中匹配的票证创建的团队大小。 例如，如果你的游戏预期是 4v4，你应创建两项，预期每个项的最大大小为 4，并采用不同名称。 还有最小团队大小，如果某个游戏在团队的玩家较少时也能玩，则使用此大小。 否则，最小值和最大值应相同。


#### <a name="using-team-rules"></a>使用团队规则

配置团队规则后，如果无法使漏斗内票证的组刚好适合团队而不会导致拆分，那么将会阻止这些票证。 此规则会将生成的团队分配写入位于 members/constants/custom/matchmakingresult/initialTeam 下的目标会话中。 请注意，这只是建议的分配，游戏可能会发现，通过重新排列玩家，可能会创建更出色的游戏，并仍然能阻止票证拆分为不同的团队。

如果为正在进行的游戏创建票证，团队规则将需要其他信息。 例如，假设一个 4v4 游戏中有 8 个玩家，而两个玩家放弃或断开连接。 游戏将会填充这些空位，但游戏正在进行时，它无法重新安排团队。

填充正在进行的游戏的尝试用 PreserveSession 字段设置为“始终”的票证表示。 在这种情况下，因为团队都已分配给玩家，所以游戏必须指定当前的团队分配，这样匹配服务就会知道每个团队有多少位置空缺。 若要提供每个玩家所在团队的名称，请每个玩家将其团队名称写入位于 members/me/properties/system/groups 的游戏会话中。 此字段为 JArray。

上述属性写入游戏会话中之后，玩家会为此会话创建票证，以尝试寻找更多玩家。 填写票证后, 匹配服务将再次写入加入 members/constants/custom/matchmakingresult/initialTeam 的任意玩家的建议团队


###### <a name="preferring-even-teams"></a>首选均衡团队

此外，将首先对最大的团队进行匹配。 这意味着，在假设的 4v4 漏斗中，会首先将 4 个玩家的票证匹配在一起，直到不再剩余 4 个玩家的票证。 然后 3 个玩家的票证继续，根据需要抽取单一实例，以此类推。 通过这种方式，类似大小的票证通常会互相比赛（如果它们存在且未被其他规则阻止）。 注意，这会让团队规则的优先级远高于其他规则。 例如，假设你有一个有限的群体，其中包含：一个大小为 4 的高技能(A) 票证、一个大小为 4 低技能(B) 票证，以及四个大小为 1 的高技能(C-F) 票证。 团队规则会使匹配服务倾向于将 A 和 B 匹配，而不是 A、C、D、E 和 F。


###### <a name="should-variant"></a>Should 变量

Must 规则阻止在所有代中拆分票证，并提供“首选均衡团队”排序。 直到最后一代，Should 规则都相等，从最后一代起，可能会拆分票证，尽管“首选均衡团队”排序将仍处于活动状态。

## <a name="target-session-initialization-and-qos"></a>目标会话初始化和 QoS

通过 SmartMatch 匹配将一组玩家匹配到目标会话中，如 [SmartMatch 比赛]()中所述。 游戏必须采取措施来确认已经有足够数量的玩家加入，他们可以在需要时成功与其他玩家连接。 此过程称为目标会话初始化。

对于使用对等网络拓扑的游戏，目标会话初始化的一个重要方面是 QoS 度量和评估。 关联操作是 Xbox One 主机之间（或控制台和服务器之间）的延迟和带宽的度量，以及对生成的度量结果（确定节点之间的网络连接是否正常）的评估。

下面的流程图说明了如何实现目标会话和 QoS 操作的初始化。

![](../../images/multiplayer/Multiplayer_2015_Matchmaking_QoS.png)

### <a name="managed-initialization"></a>受管初始化

MPSD 支持名为“受管初始化”的功能，通过该功能，它可以在会话中所涉及的客户端上协调目标会话初始化过程。 MPSD 将自动跟踪会话的初始化阶段及相关超时，并根据需要评估客户端之间的连接状况。 受管初始化由 **MultiplayerManagedInitialization 类**表示。

| 注意                                                                                                                  |
|------------------------------------------------------------------------------------------------------------------------------------|
| 强烈建议你的游戏使用 SmartMatch 匹配以充分利用 MPSD 受管初始化功能。 |


#### <a name="managed-initialization-episodes-and-stages"></a>受管初始化剧集和阶段

只要匹配向目标会话中添加新玩家，该会话就会经历受管初始化。 SmartMatch 添加会话成员，用户状态为“已保留”，即每个成员占用一个位置，但尚未加入会话。 每组新玩家将触发新的初始化剧集。

在完成初始化后，每个玩家的初始化过程不是成功便是失败。 成功初始化的玩家可以使用目标会话开始游戏。 失败的玩家必须重新提交给匹配服务，以在另一个会话中进行匹配。 如果向匹配服务提交 *preserveSession* 参数设置为“始终”的会话，则该会话中的现有成员不会进行初始化，因为 MPSD 假定它们已正常设置。

每个托管的初始化节目这些阶段内容组成：

-   加入 -- 会话成员将自己写入会话中，将其用户状态从“已保留”改为“活动”，并上传基本数据，如安全的设备地址。
-   度量 -- 对于对等拓扑，会话成员互相度量 QoS，并将度量结果上传到会话中。
-   评估 -- MPSD 将评估前两个阶段的结果，然后确定会话和/或成员是否已成功初始化。

在会话上运行的游戏代码通过加入和度量阶段推进每个用户（进而会话）。 然后，它可以在评估阶段成功或者失败后开始游戏或者返回匹配服务。


### <a name="configuring-the-target-session-for-initialization"></a>对目标会话配置初始化

游戏可以使用正在初始化的目标会话中的常量配置受管初始化过程。 这些常量在版本为 107 的会话模板中的 /constants/system 下进行设置，该版本为建议模板版本。 可以进行两种类型的配置设置：将受管初始化过程作为整体进行配置的设置，以及配置 QoS 要求的设置。 有关常见游戏场景的会话模板示例，请参阅 [MPSD 会话模板](multiplayer-session-directory.md)。

| 注意                                                                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------------|
| 如果目标会话初始化配置中未定义 QoS 要求，则会跳过初始化期间的度量阶段。 |


#### <a name="configuring-managed-initialization-as-a-whole"></a>将受管初始化作为整体配置

以下是要设置用来整体控制受管初始化的字段。 它们是 /constants/system/memberInitialization 对象的一部分：
- joinTimeout。 指定初始化剧集开始后，MPSD 等待每个成员加入的时间。 默认值为 10 秒。
-   measurementTimeout。 指定度量阶段开始后，MPSD 等待每个成员上传 QoS 度量结果的时间。 默认值为 30000 秒。
-   membersNeededToStart。 指定首个初始化剧集若要成功，必须在初始化时成功的成员数量。 默认值为 1。

| 注意                                              |
|----------------------------------------------------------------|
| 如果不满足此阈值，所有成员初始化均失败。 |


#### <a name="configuring-qos-requirements"></a>配置 QoS 要求

如果游戏使用对等或端点对主机拓扑，则只在初始化过程中才需要 QoS。 每个拓扑映射到 /constants/system/ 下的拓扑特定常量。
###### <a name="configuring-qos-requirements-for-peer-to-peer-topology"></a>配置对等拓扑的 QoS 要求

| 注意                                                                                                                                                                                         |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 游戏为对等拓扑进行 QoS 要求设置的情况很少见。 这些设置非常严格，对于网络地址转换 (NAT) 比较严格的玩家来说，会出现问题。 |

对等拓扑 QOS 要求在 peerToPeerRequirements 对象中进行设置。 每个客户端必须能够与其他每个客户端连接。 对象具有以下相关字段：
-   latencyMaximum。 指定任何两个客户端之间的最大延迟。
-   bandwidthMinimum。 指定任何两个客户端之间的最小带宽。


###### <a name="configuring-qos-requirements-for-peer-to-host-topology"></a>配置端点对主机拓扑的 QoS 要求

端点对主机拓扑 QOS 要求在 peerToHostRequirements 对象中进行设置。 每个客户端必须能够与单个常用主机连接。 如果此对象已配置并且初始化成功，MPSD 将创建可能是潜在主机的客户端的初始列表，称为“候选主机。” 以下是要设置的字段：
-   latencyMaximum。 指定每个对等和主机之间的最大延迟。
-   bandwidthDownMinimum。 指定每个对等和主机之间的最小下游带宽。
-   bandwidthUpMinimum。 指定每个对等和主机之间的最小上游带宽。
-   hostSelectionMetric。 指定用于选择主机的指标。

## <a name="see-also"></a>另请参阅

[为你的游戏配置 SmartMatch]()

[MPSD 会话模板](multiplayer-session-directory.md)

[SmartMatch 运行时操作]()
